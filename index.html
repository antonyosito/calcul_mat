<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora de Materiales</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .config-section {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 6px;
      flex-wrap: wrap;
    }
    .config-item {
      display: flex;
      flex-direction: column;
    }
    .config-item label {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 0.9em;
    }
    .config-item input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 120px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.85em;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #3498db;
      color: white;
      font-weight: bold;
      white-space: nowrap;
    }
    input[type=number], select {
      width: 100%;
      padding: 4px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .total {
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 20px;
      text-align: right;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 4px;
    }
    button {
      margin-top: 10px;
      padding: 8px 15px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    .formato {
      background-color: #d4ffd4;
    }
    .retal {
      background-color: #fff8cd;
    }
    .delete-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .delete-btn:hover {
      background-color: #c0392b;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .result-cell {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Calculadora de Materiales</h2>

    <div class="config-section">
      <div class="config-item">
        <label for="descuentoAumento">Descuento/Aumento (%):</label>
        <input type="number" id="descuentoAumento" step="0.01" value="0">
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="aplicarDescuento">
        <label for="aplicarDescuento">Aplicar descuento</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="aplicarAumento" checked>
        <label for="aplicarAumento">Aplicar aumento</label>
      </div>
    </div>

    <table id="tabla">
      <thead>
        <tr>
          <th>Material</th>
          <th>Ancho (mm)</th>
          <th>Largo (mm)</th>
          <th>Espesor (mm)</th>
          <th>Cantidad</th>
          <th>Peso Unit. (kg)</th>
          <th>Peso Total (kg)</th>
          <th>Tipo</th>
          <th>Precio kg venta</th>
          <th>Precio unitario</th>
          <th>Precio total</th>
          <th>+IVA (19%)</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="actions">
      <button onclick="agregarFila()">Agregar Fila</button>
      <div class="total" id="totalFinal">Total + IVA (19%): $0.00</div>
    </div>
  </div>

  <script>
    let db = [];
    let formatos = [];

    // Datos de ejemplo (en lugar de fetch)
    const materialesData = [
      {
        "MATERIAL": "HR",
        "Densidad Kg/mm³": "0.00000785",
        "Calibre (esp)": "1/2\"\"",
        "Calibre (mm)": "12.7",
        "Formato": "4 x 8",
        "ancho ": "4",
        "largo ": "8",
        "Ancho (mm)": "1220",
        "Largo (mm)": "2440",
        "KILOS": "296.77 Kg",
        "% Utilidad fornato lámina completa": "1.10",
        "% venta x kg cortado": "1.70",
        "Precio kg compra": "3250",
        "Valor formato unid sin iva": "964,509",
        "Precio venta kilo cortado": " $ 5,525 ",
        "Vlr del kilo para venta lamina completa": "3575",
        "Vlr final Venta Lámina completa": " 1,060,960 ",
        "": ""
      },
      {
        "MATERIAL": "HR",
        "Densidad Kg/mm³": "0.00000785",
        "Calibre (esp)": "1/2\"\"",
        "Calibre (mm)": "12.7",
        "Formato": "120 x 6",
        "ancho ": "120",
        "largo ": "6",
        "Ancho (mm)": "1200",
        "Largo (mm)": "6000",
        "KILOS": "717.80 Kg",
        "% Utilidad fornato lámina completa": "1.10",
        "% venta x kg cortado": "1.70",
        "Precio kg compra": "3250",
        "Valor formato unid sin iva": "2,332,863",
        "Precio venta kilo cortado": " $ 5,525 ",
        "Vlr del kilo para venta lamina completa": "3575",
        "Vlr final Venta Lámina completa": " 2,566,149 ",
        "": ""
      },
      {
        "MATERIAL": "GALV",
        "Densidad Kg/mm³": "0.00000785",
        "Calibre (esp)": "c16",
        "Calibre (mm)": "1.5",
        "Formato": "4 x 8",
        "ancho ": "4",
        "largo ": "8",
        "Ancho (mm)": "1220",
        "Largo (mm)": "2440",
        "KILOS": "35.05 Kg",
        "% Utilidad fornato lámina completa": "1.12",
        "% venta x kg cortado": "1.70",
        "Precio kg compra": "4850",
        "Valor formato unid sin iva": "170,001",
        "Precio venta kilo cortado": " $ 8,245 ",
        "Vlr del kilo para venta lamina completa": "5432",
        "Vlr final Venta Lámina completa": " 190,401 ",
        "": ""
      }
    ];

    // Inicializar datos
    db = materialesData;
    formatos = [...new Set(db.map(item => item.Formato))];

    function detectarFormato(material, ancho, largo, espesor) {
      return db.find(item =>
        item.MATERIAL === material &&
        Math.abs(item["Ancho (mm)"] - ancho) < 5 &&
        Math.abs(item["Largo (mm)"] - largo) < 5 &&
        Math.abs(parseFloat(item["Calibre (mm)"]) - espesor) < 0.1
      );
    }

    function calcularPeso(ancho, largo, espesor, densidad) {
      // Convertir densidad de string a número
      const densidadNum = parseFloat(densidad);
      return (ancho * largo * espesor * densidadNum);
    }

    function limpiarValorMonetario(valor) {
      return parseFloat(valor.toString().replace(/[^\d.]/g, '')) || 0;
    }

    function actualizarFila(fila) {
      const material = fila.querySelector(".material").value;
      const ancho = parseFloat(fila.querySelector(".ancho").value) || 0;
      const largo = parseFloat(fila.querySelector(".largo").value) || 0;
      const espesor = parseFloat(fila.querySelector(".espesor").value) || 0;
      const cantidad = parseFloat(fila.querySelector(".cantidad").value) || 1;

      // Obtener porcentaje de descuento/aumento
      const porcentaje = parseFloat(document.getElementById("descuentoAumento").value) || 0;
      const aplicarDescuento = document.getElementById("aplicarDescuento").checked;
      const aplicarAumento = document.getElementById("aplicarAumento").checked;

      const item = detectarFormato(material, ancho, largo, espesor);

      if (!item) {
        // Es un retal - buscar material y espesor coincidentes
        const itemRetal = db.find(i => 
          i.MATERIAL === material && 
          Math.abs(parseFloat(i["Calibre (mm)"]) - espesor) < 0.1
        );
        
        if (!itemRetal) {
          fila.className = "retal";
          fila.querySelector(".tipo").innerText = "Retal";
          fila.querySelector(".pesoUnit").innerText = "0.00";
          fila.querySelector(".pesoTotal").innerText = "0.00";
          fila.querySelector(".precioKg").innerText = "0.00";
          fila.querySelector(".precioUnit").innerText = "0.00";
          fila.querySelector(".precioTotal").innerText = "0.00";
          fila.querySelector(".precioIVA").innerText = "0.00";
          actualizarTotal();
          return;
        }

        fila.className = "retal";
        fila.querySelector(".tipo").innerText = "Retal";

        // Calcular peso
        const pesoUnitario = calcularPeso(ancho, largo, espesor, itemRetal["Densidad Kg/mm³"]);
        const pesoTotal = pesoUnitario * cantidad;
        
        // Obtener precio para retal (precio por kg cortado)
        let precioKg = limpiarValorMonetario(itemRetal["Precio venta kilo cortado"]);
        
        // Aplicar descuento/aumento
        if (aplicarDescuento && porcentaje > 0) {
          precioKg = precioKg * (1 - porcentaje / 100);
        } else if (aplicarAumento && porcentaje > 0) {
          precioKg = precioKg * (1 + porcentaje / 100);
        }
        
        // Calcular precios
        const precioUnitario = pesoUnitario * precioKg;
        const precioTotal = precioUnitario * cantidad;
        const precioIVA = precioTotal * 1.19;

        fila.querySelector(".pesoUnit").innerText = pesoUnitario.toFixed(2);
        fila.querySelector(".pesoTotal").innerText = pesoTotal.toFixed(2);
        fila.querySelector(".precioKg").innerText = precioKg.toFixed(2);
        fila.querySelector(".precioUnit").innerText = precioUnitario.toFixed(2);
        fila.querySelector(".precioTotal").innerText = precioTotal.toFixed(2);
        fila.querySelector(".precioIVA").innerText = precioIVA.toFixed(2);
      } else {
        // Es un formato
        fila.className = "formato";
        fila.querySelector(".tipo").innerText = "Formato";

        // Calcular peso
        const pesoUnitario = calcularPeso(ancho, largo, espesor, item["Densidad Kg/mm³"]);
        const pesoTotal = pesoUnitario * cantidad;
        
        // Obtener precio para formato (precio de lámina completa)
        let precioUnitario = limpiarValorMonetario(item["Vlr final Venta Lámina completa"]);
        
        // Aplicar descuento/aumento
        if (aplicarDescuento && porcentaje > 0) {
          precioUnitario = precioUnitario * (1 - porcentaje / 100);
        } else if (aplicarAumento && porcentaje > 0) {
          precioUnitario = precioUnitario * (1 + porcentaje / 100);
        }
        
        // Calcular precio por kg
        const precioKg = precioUnitario / pesoUnitario;
        
        // Calcular precios
        const precioTotal = precioUnitario * cantidad;
        const precioIVA = precioTotal * 1.19;

        fila.querySelector(".pesoUnit").innerText = pesoUnitario.toFixed(2);
        fila.querySelector(".pesoTotal").innerText = pesoTotal.toFixed(2);
        fila.querySelector(".precioKg").innerText = precioKg.toFixed(2);
        fila.querySelector(".precioUnit").innerText = precioUnitario.toFixed(2);
        fila.querySelector(".precioTotal").innerText = precioTotal.toFixed(2);
        fila.querySelector(".precioIVA").innerText = precioIVA.toFixed(2);
      }

      actualizarTotal();
    }

    function actualizarTotal() {
      let total = 0;
      document.querySelectorAll(".precioIVA").forEach(td => {
        total += parseFloat(td.innerText) || 0;
      });
      document.getElementById("totalFinal").innerText = `Total + IVA (19%): $${total.toFixed(2)}`;
    }

    function agregarFila() {
      const tbody = document.querySelector("#tabla tbody");
      const fila = document.createElement("tr");

      // Obtener materiales únicos
      const materiales = [...new Set(db.map(i => i.MATERIAL))];
      
      // Obtener espesores únicos
      const espesores = [...new Set(db.map(i => parseFloat(i["Calibre (mm)"])))].sort((a, b) => a - b);

      fila.innerHTML = `
        <td>
          <select class="material">
            <option value="">Seleccionar</option>
            ${materiales.map(m => `<option value="${m}">${m}</option>`).join('')}
          </select>
        </td>
        <td><input type="number" class="ancho" step="1" min="0"></td>
        <td><input type="number" class="largo" step="1" min="0"></td>
        <td>
          <select class="espesor">
            <option value="">Seleccionar</option>
            ${espesores.map(e => `<option value="${e}">${e}</option>`).join('')}
          </select>
        </td>
        <td><input type="number" class="cantidad" value="1" min="1"></td>
        <td class="pesoUnit result-cell">0.00</td>
        <td class="pesoTotal result-cell">0.00</td>
        <td class="tipo">-</td>
        <td class="precioKg result-cell">0.00</td>
        <td class="precioUnit result-cell">0.00</td>
        <td class="precioTotal result-cell">0.00</td>
        <td class="precioIVA result-cell">0.00</td>
        <td><button class="delete-btn" onclick="this.parentElement.parentElement.remove();actualizarTotal();">Eliminar</button></td>
      `;

      fila.querySelectorAll("input, select").forEach(input => {
        input.addEventListener("input", () => actualizarFila(fila));
      });

      // Agregar eventos para los checkboxes de descuento/aumento
      document.getElementById("aplicarDescuento").addEventListener("change", () => {
        document.querySelectorAll("tr:not(:first-child)").forEach(fila => {
          if (fila.querySelector(".material")) actualizarFila(fila);
        });
      });
      
      document.getElementById("aplicarAumento").addEventListener("change", () => {
        document.querySelectorAll("tr:not(:first-child)").forEach(fila => {
          if (fila.querySelector(".material")) actualizarFila(fila);
        });
      });
      
      document.getElementById("descuentoAumento").addEventListener("input", () => {
        document.querySelectorAll("tr:not(:first-child)").forEach(fila => {
          if (fila.querySelector(".material")) actualizarFila(fila);
        });
      });

      tbody.appendChild(fila);
    }

    // Inicializar con una fila
    agregarFila();
  </script>
</body>
</html>
