<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Costo de Corte DXF - Avanzada</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }
        
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 0;
        }
        
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 0;
        }
        
        .card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 { 
            color: #2c3e50; 
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        
        h2 {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        h3 {
            font-size: 1.1em;
            color: #34495e;
            margin-bottom: 10px;
        }
        
        .subtitle { 
            color: #666; 
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .file-input-section {
            margin-bottom: 10px;
        }
        
        input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
        }
        
        .table-wrapper {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 350px;
        }

        .files-table {
            min-width: 900px;
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .files-table th:nth-child(1) { width: 140px; } /* Archivo */
        .files-table th:nth-child(2) { width: 100px; } /* Material */
        .files-table th:nth-child(3) { width: 90px; }  /* Dimensiones */
        .files-table th:nth-child(4) { width: 80px; }  /* Longitud */
        .files-table th:nth-child(5) { width: 70px; }  /* Contornos */
        .files-table th:nth-child(6) { width: 80px; }  /* Tiempo */
        .files-table th:nth-child(7) { width: 90px; }  /* Costo Unit. */
        .files-table th:nth-child(8) { width: 80px; }  /* Cantidad */
        .files-table th:nth-child(9) { width: 100px; } /* Acciones */
        
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        tr.selected {
            background-color: #e3f2fd;
        }
        
        .file-actions {
            display: flex;
            gap: 4px;
        }
        
        .btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 0.85em;
        }
        
        .quantity-input {
            width: 60px;
            text-align: center;
        }
        
        .results-summary {
            margin-top: 10px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }
        
        .result-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .result-value {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .result-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 4px;
        }
        
        .total-cost {
            background: #2ecc71;
            color: white;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            margin-top: 8px;
        }
        
        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }
        
        #dxfCanvas {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fafafa;
            min-height: 300px;
        }
        
        .canvas-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .canvas-controls .btn {
            padding: 6px 12px;
            font-size: 0.9em;
        }
        
        .canvas-info {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 8px;
        }
        
        .cost-display {
            font-weight: bold;
            color: #27ae60;
            font-size: 0.9em;
        }
        
        .no-files {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }
        
        .file-name {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .dimensions {
            font-size: 0.8em;
            color: #666;
        }
        
        .time-display {
            font-size: 0.8em;
            color: #666;
        }
        
        /* Filtros y búsqueda */
        .filters-section {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 120px;
        }
        
        .search-box {
            flex: 2;
            min-width: 200px;
        }
        
        /* Controles globales */
        .global-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .global-controls .btn {
            flex: 1;
            padding: 8px;
        }
        
        /* Estados */
        .high-cost {
            background-color: #ffebee;
        }
        
        .low-cost {
            background-color: #e8f5e8;
        }
        
        /* Estadísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 8px;
            font-size: 0.8em;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            text-align: center;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            min-width: 400px;
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Panel izquierdo: Controles y tabla -->
        <div class="left-panel">
            <!-- Cabecera -->
            <div class="card">
                <h1>Calculadora de Corte DXF - Avanzada</h1>
                <p class="subtitle">Gestión completa de cotizaciones para corte láser</p>
                
                <div class="file-input-section">
                    <input type="file" id="dxfFiles" accept=".dxf" multiple>
                    <!-- INPUT SEPARADO PARA CARGAR PROYECTOS -->
                    <input type="file" id="loadProjectFile" accept=".json" style="display: none;">
                </div>
                
                <!-- Controles globales -->
                <div class="global-controls">
                    <button class="btn btn-success" id="exportBtn">Exportar CSV</button>
                    <button class="btn btn-warning" id="saveProjectBtn">Guardar Proyecto</button>
                    <button class="btn btn-primary" id="loadProjectBtn">Cargar Proyecto</button>
                    <button class="btn btn-primary" id="configBtn">Configuración</button>
                </div>
                
                <!-- Filtros y búsqueda -->
                <div class="filters-section">
                    <div class="search-box">
                        <input type="text" id="searchBox" placeholder="Buscar archivos...">
                    </div>
                    <div class="filter-group">
                        <select id="materialFilter">
                            <option value="">Todos los materiales</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select id="costFilter">
                            <option value="">Todos los costos</option>
                            <option value="high">Alto costo</option>
                            <option value="low">Bajo costo</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Tabla de archivos -->
            <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                <h3>Archivos Cargados <small id="fileCount">(0 archivos)</small></h3>
                <div class="table-wrapper">
                    <table class="files-table">
                        <thead>
                            <tr>
                                <th>Archivo</th>
                                <th>Material</th>
                                <th>Dimensiones</th>
                                <th>Longitud</th>
                                <th>Contornos</th>
                                <th>Tiempo</th>
                                <th>Costo Unit.</th>
                                <th>Cantidad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="filesTableBody">
                            <!-- Las filas de archivos se insertarán aquí -->
                        </tbody>
                    </table>
                    <div id="noFilesMessage" class="no-files">
                        No hay archivos cargados. Cargue archivos DXF para comenzar.
                    </div>
                </div>
            </div>
            
            <!-- Resumen de resultados -->
            <div class="card">
                <h3>Resumen de Cotización</h3>
                <div class="results-grid">
                    <div class="result-item">
                        <div class="result-label">Metros Lineales</div>
                        <div class="result-value" id="totalLength">0 m</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Total Contornos</div>
                        <div class="result-value" id="totalEntities">0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Tiempo Total</div>
                        <div class="result-value" id="totalTime">0 min</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Piezas Totales</div>
                        <div class="result-value" id="totalPieces">0</div>
                    </div>
                </div>
                
                <!-- Estadísticas rápidas -->
                <div class="stats-grid">
                    <div class="stat-item">
                        <div>Archivos: <span id="statsFiles">0</span></div>
                    </div>
                    <div class="stat-item">
                        <div>Materiales: <span id="statsMaterials">0</span></div>
                    </div>
                    <div class="stat-item">
                        <div>Promedio: $<span id="statsAverage">0</span></div>
                    </div>
                </div>
                
                <div class="total-cost">
                    <div class="result-label">COSTO TOTAL ESTIMADO</div>
                    <div class="result-value" style="font-size: 1.4em; color: white;" id="totalCost">$0</div>
                </div>
            </div>
        </div>
        
        <!-- Panel derecho: Canvas y visualización -->
        <div class="right-panel">
            <div class="canvas-container">
                <h3>Vista Previa DXF</h3>
                <canvas id="dxfCanvas"></canvas>
                <div class="canvas-controls">
                    <button class="btn btn-primary" id="zoomInBtn">Zoom +</button>
                    <button class="btn btn-primary" id="zoomOutBtn">Zoom -</button>
                    <button class="btn btn-primary" id="fitViewBtn">Ajustar</button>
                    <button class="btn btn-primary" id="resetViewBtn">Reset</button>
                    <button class="btn btn-warning" id="toggleGridBtn">Grid</button>
                </div>
                <div class="canvas-info" id="canvasInfo">
                    Seleccione un archivo de la tabla para visualizarlo
                </div>
                <div class="canvas-info" id="dimensionsInfo">
                    Dimensiones: No seleccionado
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para configuración avanzada -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <h3>Configuración Avanzada</h3>
            <div style="margin: 15px 0;">
                <label>Costo por minuto ($/min):</label>
                <input type="number" id="globalCostPerMinute" value="10000" min="0" step="100">
            </div>
            <div style="margin: 15px 0;">
                <label>Tiempo por contorno (seg):</label>
                <input type="number" id="globalTimePerContour" value="3.5" min="0" step="0.1">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" id="saveConfigBtn">Guardar</button>
                <button class="btn btn-danger" id="closeConfigBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/dxf-parser@1.1.2/dist/dxf-parser.min.js"></script>
    <script>
        // Definición de materiales y velocidades de corte (mm/s)
        const materials = {
            "ALUM1MM": 116.667, "ALUM2MM": 75.0, "ALUM3MM": 33.333, "ALUM4MM": 21.667, "ALUM6MM": 16.667,
            "BRONCE1.5MM": 150.0, "BRONCE6MM": 20.0, "COBREC20": 116.667,
            "CR1.2MM": 183.333, "CR1.5MM": 166.667, "CR1.9MM": 183.333,
            "GALV0.9MM": 250.0, "GALV1.2MM": 250.0, "GALV1.5MM": 200.0, "GAV1.9MM": 133.333,
            "HR12MM": 15.0, "HR15MM": 15.0, "HR2MM": 116.667, "HR2.5MM": 116.667, "HR3MM": 103.333,
            "HR4.5MM": 40.0, "HR6MM": 36.667, "HR8MM": 27.5, "HR9MM": 23.667, "HR19MM": 250.0, "HR25MM": 6.0,
            "INOX0.9MM": 416.667, "INOX1.2MM": 250.0, "INOX1.5MM": 183.333, "INOX1.9MM": 166.667, "INOX2.5MM": 116.667,
            "INOX3MM": 116.667, "INOX4.5MM": 33.333, "INOX6MM": 33.333, "INOX8MM": 16.667, "INOX9MM": 13.333, "INOX12MM": 25.0
        };

        // Variables globales
        let loadedFiles = [];
        let currentFileIndex = -1;
        let currentScale = 1;
        let currentOffsetX = 0;
        let currentOffsetY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let showGrid = false;
        let COST_PER_MINUTE = 10000;
        let TIME_PER_CONTOUR_S = 3.5;

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        function initializeApp() {
            // Configurar controles del canvas
            document.getElementById('zoomInBtn').addEventListener('click', () => {
                currentScale *= 1.2;
                drawCurrentFile();
            });
            
            document.getElementById('zoomOutBtn').addEventListener('click', () => {
                currentScale /= 1.2;
                drawCurrentFile();
            });
            
            document.getElementById('resetViewBtn').addEventListener('click', () => {
                currentScale = 1;
                currentOffsetX = 0;
                currentOffsetY = 0;
                drawCurrentFile();
            });

            document.getElementById('fitViewBtn').addEventListener('click', () => {
                currentScale = 1;
                currentOffsetX = 0;
                currentOffsetY = 0;
                drawCurrentFile();
            });

            document.getElementById('toggleGridBtn').addEventListener('click', () => {
                showGrid = !showGrid;
                drawCurrentFile();
            });

            // Configurar eventos del canvas
            const canvas = document.getElementById('dxfCanvas');
            canvas.addEventListener('mousedown', startDragging);
            canvas.addEventListener('mousemove', drag);
            canvas.addEventListener('mouseup', stopDragging);
            canvas.addEventListener('mouseleave', stopDragging);

            // Configurar carga de archivos DXF
            document.getElementById('dxfFiles').addEventListener('change', handleFileSelection);

            // Configurar carga de proyectos JSON
            document.getElementById('loadProjectFile').addEventListener('change', handleProjectLoad);

            // Configurar filtros
            document.getElementById('searchBox').addEventListener('input', filterFiles);
            document.getElementById('materialFilter').addEventListener('change', filterFiles);
            document.getElementById('costFilter').addEventListener('change', filterFiles);

            // Configurar botones globales
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('saveProjectBtn').addEventListener('click', saveProject);
            document.getElementById('loadProjectBtn').addEventListener('click', () => {
                document.getElementById('loadProjectFile').click();
            });
            document.getElementById('configBtn').addEventListener('click', () => {
                document.getElementById('configModal').style.display = 'block';
            });

            // Configurar modal
            document.getElementById('closeConfigBtn').addEventListener('click', () => {
                document.getElementById('configModal').style.display = 'none';
            });

            document.getElementById('saveConfigBtn').addEventListener('click', saveConfig);

            // Llenar filtro de materiales
            populateMaterialFilter();

            updateResults();
        }

        // NUEVA FUNCIÓN: Cargar proyecto desde JSON
        function handleProjectLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const project = JSON.parse(e.target.result);
                    
                    // Validar que sea un proyecto válido
                    if (!project.files || !Array.isArray(project.files)) {
                        throw new Error('Archivo de proyecto inválido');
                    }
                    
                    // Limpiar archivos actuales
                    loadedFiles = [];
                    currentFileIndex = -1;
                    
                    // Cargar archivos del proyecto
                    project.files.forEach(fileData => {
                        loadedFiles.push({
                            name: fileData.name,
                            dxf: fileData.dxf, // Mantenemos los datos DXF parseados
                            bounds: fileData.bounds,
                            info: fileData.info,
                            material: fileData.material,
                            cost: fileData.cost,
                            time: fileData.time,
                            quantity: fileData.quantity || 1,
                            notes: fileData.notes || ''
                        });
                    });
                    
                    // Cargar configuración si existe
                    if (project.settings) {
                        COST_PER_MINUTE = project.settings.costPerMinute || 10000;
                        TIME_PER_CONTOUR_S = project.settings.timePerContour || 3.5;
                        
                        // Actualizar valores en el modal
                        document.getElementById('globalCostPerMinute').value = COST_PER_MINUTE;
                        document.getElementById('globalTimePerContour').value = TIME_PER_CONTOUR_S;
                    }
                    
                    // Actualizar interfaz
                    updateFilesTable();
                    updateResults();
                    
                    // Seleccionar primer archivo si hay
                    if (loadedFiles.length > 0) {
                        selectFile(0);
                    }
                    
                    alert(`Proyecto cargado exitosamente: ${loadedFiles.length} archivos`);
                    
                } catch (err) {
                    console.error('Error al cargar proyecto:', err);
                    alert('Error al cargar el proyecto: ' + err.message);
                }
            };
            
            reader.onerror = function() {
                alert('Error al leer el archivo de proyecto');
            };
            
            reader.readAsText(file);
            
            // Limpiar input
            event.target.value = '';
        }

        function populateMaterialFilter() {
            const filter = document.getElementById('materialFilter');
            filter.innerHTML = '<option value="">Todos los materiales</option>';
            for (const material in materials) {
                const option = document.createElement('option');
                option.value = material;
                option.textContent = material;
                filter.appendChild(option);
            }
        }

        function handleFileSelection(event) {
            const files = event.target.files;
            if (!files.length) return;

            Array.from(files).forEach(file => {
                if (loadedFiles.some(f => f.name === file.name)) return;

                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const parser = new DxfParser();
                        const dxf = parser.parseSync(e.target.result);
                        
                        const bounds = getDxfBounds(dxf);
                        const fileInfo = calculateFileInfo(dxf);
                        
                        loadedFiles.push({
                            name: file.name,
                            dxf: dxf,
                            bounds: bounds,
                            info: fileInfo,
                            material: Object.keys(materials)[0],
                            cost: 0,
                            time: 0,
                            quantity: 1,
                            notes: ''
                        });
                        
                        updateFilesTable();
                        updateFileCost(loadedFiles.length - 1);
                        
                        if (loadedFiles.length === 1) {
                            selectFile(0);
                        }
                        
                        updateResults();
                    } catch (err) {
                        console.error('Error al procesar el archivo DXF:', err);
                        alert(`Error en ${file.name}: ${err.message}`);
                    }
                };
                
                reader.readAsText(file);
            });
            
            event.target.value = '';
        }

        function calculateFileInfo(dxf) {
            let totalLengthMm = 0;
            let totalEntities = 0;
            
            dxf.entities.forEach(entity => {
                let length = 0;
                
                switch (entity.type) {
                    case 'LINE':
                        if (entity.start && entity.end) {
                            length = distance([entity.start.x, entity.start.y], [entity.end.x, entity.end.y]);
                            totalEntities++;
                        }
                        break;
                    case 'LWPOLYLINE':
                    case 'POLYLINE':
                        if (entity.vertices && entity.vertices.length > 0) {
                            for (let i = 1; i < entity.vertices.length; i++) {
                                length += distance(
                                    [entity.vertices[i-1].x, entity.vertices[i-1].y],
                                    [entity.vertices[i].x, entity.vertices[i].y]
                                );
                            }
                            if (entity.isClosed && entity.vertices.length > 1) {
                                length += distance(
                                    [entity.vertices[entity.vertices.length-1].x, entity.vertices[entity.vertices.length-1].y],
                                    [entity.vertices[0].x, entity.vertices[0].y]
                                );
                            }
                            totalEntities++;
                        }
                        break;
                    case 'ARC':
                        if (entity.radius && entity.startAngle !== undefined && entity.endAngle !== undefined) {
                            const radius = entity.radius;
                            let startAngle = entity.startAngle;
                            let endAngle = entity.endAngle;
                            if (startAngle > endAngle) endAngle += 360;
                            const angleRad = (endAngle - startAngle) * (Math.PI / 180);
                            length = radius * angleRad;
                            totalEntities++;
                        }
                        break;
                    case 'CIRCLE':
                        if (entity.radius) {
                            length = 2 * Math.PI * entity.radius;
                            totalEntities++;
                        }
                        break;
                    case 'ELLIPSE':
                        if (typeof entity.majorAxis === 'number' && typeof entity.axisRatio === 'number') {
                            const a = entity.majorAxis;
                            const b = a * entity.axisRatio;
                            length = Math.PI * (3 * (a + b) - Math.sqrt((3 * a + b) * (a + 3 * b)));
                            if (!isNaN(length) && length > 0) totalEntities++;
                        }
                        break;
                    case 'SPLINE':
                        if (entity.controlPoints && entity.controlPoints.length > 0) {
                            for (let i = 1; i < entity.controlPoints.length; i++) {
                                length += distance(
                                    [entity.controlPoints[i-1].x, entity.controlPoints[i-1].y],
                                    [entity.controlPoints[i].x, entity.controlPoints[i].y]
                                );
                            }
                            totalEntities++;
                        }
                        break;
                }
                totalLengthMm += length;
            });
            
            return { totalLengthMm, totalEntities };
        }

        function updateFilesTable() {
            const tableBody = document.getElementById('filesTableBody');
            const noFilesMessage = document.getElementById('noFilesMessage');
            const fileCount = document.getElementById('fileCount');
            
            if (loadedFiles.length === 0) {
                tableBody.innerHTML = '';
                noFilesMessage.style.display = 'block';
                fileCount.textContent = '(0 archivos)';
                return;
            }
            
            noFilesMessage.style.display = 'none';
            fileCount.textContent = `(${loadedFiles.length} archivos)`;
            tableBody.innerHTML = '';
            
            loadedFiles.forEach((file, index) => {
                const row = document.createElement('tr');
                if (index === currentFileIndex) row.className = 'selected';
                
                // Aplicar clases de costo
                const unitCost = file.cost / file.quantity;
                if (unitCost > 50000) row.classList.add('high-cost');
                if (unitCost < 10000) row.classList.add('low-cost');
                
                // Archivo
                const fileCell = document.createElement('td');
                fileCell.className = 'file-name';
                fileCell.title = file.name;
                fileCell.textContent = file.name;
                row.appendChild(fileCell);
                
                // Material
                const materialCell = document.createElement('td');
                const materialSelect = document.createElement('select');
                materialSelect.value = file.material;
                
                for (const materialKey in materials) {
                    const option = document.createElement('option');
                    option.value = materialKey;
                    option.textContent = materialKey;
                    if (materialKey === file.material) option.selected = true;
                    materialSelect.appendChild(option);
                }
                
                materialSelect.addEventListener('change', (e) => {
                    file.material = e.target.value;
                    updateFileCost(index);
                    updateResults();
                });
                
                materialCell.appendChild(materialSelect);
                row.appendChild(materialCell);
                
                // Dimensiones
                const dimensionsCell = document.createElement('td');
                dimensionsCell.className = 'dimensions';
                dimensionsCell.textContent = `${file.bounds.width.toFixed(0)}x${file.bounds.height.toFixed(0)}mm`;
                dimensionsCell.title = `Ancho: ${file.bounds.width.toFixed(1)}mm, Alto: ${file.bounds.height.toFixed(1)}mm`;
                row.appendChild(dimensionsCell);
                
                // Longitud
                const lengthCell = document.createElement('td');
                lengthCell.textContent = (file.info.totalLengthMm / 1000).toFixed(2) + 'm';
                row.appendChild(lengthCell);
                
                // Contornos
                const entitiesCell = document.createElement('td');
                entitiesCell.textContent = file.info.totalEntities;
                row.appendChild(entitiesCell);
                
                // Tiempo
                const timeCell = document.createElement('td');
                timeCell.className = 'time-display';
                timeCell.textContent = file.time.toFixed(1) + 'm';
                row.appendChild(timeCell);
                
                // Costo Unitario
                const costCell = document.createElement('td');
                costCell.className = 'cost-display';
                costCell.textContent = `$${(file.cost / file.quantity).toFixed(0)}`;
                row.appendChild(costCell);
                
                // Cantidad
                const quantityCell = document.createElement('td');
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.className = 'quantity-input';
                quantityInput.value = file.quantity;
                quantityInput.min = 1;
                quantityInput.addEventListener('change', (e) => {
                    file.quantity = parseInt(e.target.value) || 1;
                    updateResults();
                });
                quantityCell.appendChild(quantityInput);
                row.appendChild(quantityCell);
                
                // Acciones
                const actionsCell = document.createElement('td');
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'file-actions';
                
                const selectBtn = document.createElement('button');
                selectBtn.className = 'btn btn-primary';
                selectBtn.textContent = 'Ver';
                selectBtn.onclick = () => selectFile(index);
                
                const configBtn = document.createElement('button');
                configBtn.className = 'btn btn-warning';
                configBtn.textContent = '⚙';
                configBtn.title = 'Configurar';
                configBtn.onclick = () => showFileConfig(index);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger';
                removeBtn.textContent = 'X';
                removeBtn.onclick = () => removeFile(index);
                
                actionsDiv.appendChild(selectBtn);
                actionsDiv.appendChild(configBtn);
                actionsDiv.appendChild(removeBtn);
                actionsCell.appendChild(actionsDiv);
                row.appendChild(actionsCell);
                
                tableBody.appendChild(row);
            });
        }

        function updateFileCost(index) {
            const file = loadedFiles[index];
            if (!file) return;
            
            const cuttingSpeed = materials[file.material];
            const totalLengthMm = file.info.totalLengthMm;
            const totalEntities = file.info.totalEntities;
            
            const cuttingTime = (totalLengthMm / cuttingSpeed) / 60;
            const piercingAndMoveTime = totalEntities * (TIME_PER_CONTOUR_S / 60);
            const totalTime = cuttingTime + piercingAndMoveTime;
            
            const baseCost = totalTime * COST_PER_MINUTE;
            const roundingMultiplier = 50;
            const totalCost = Math.ceil(baseCost / roundingMultiplier) * roundingMultiplier;
            
            file.time = totalTime;
            file.cost = totalCost * file.quantity;
            
            updateFilesTable();
        }

        function updateResults() {
            let totalLengthMm = 0;
            let totalEntities = 0;
            let totalTime = 0;
            let totalCost = 0;
            let totalPieces = 0;
            let uniqueMaterials = new Set();
            
            loadedFiles.forEach(file => {
                totalLengthMm += file.info.totalLengthMm * file.quantity;
                totalEntities += file.info.totalEntities * file.quantity;
                totalTime += file.time * file.quantity;
                totalCost += file.cost;
                totalPieces += file.quantity;
                uniqueMaterials.add(file.material);
            });
            
            document.getElementById('totalLength').textContent = (totalLengthMm / 1000).toFixed(2) + ' m';
            document.getElementById('totalEntities').textContent = totalEntities;
            document.getElementById('totalTime').textContent = totalTime.toFixed(1);
            document.getElementById('totalPieces').textContent = totalPieces;
            document.getElementById('totalCost').textContent = `$${totalCost.toFixed(0)}`;
            
            // Actualizar estadísticas
            document.getElementById('statsFiles').textContent = loadedFiles.length;
            document.getElementById('statsMaterials').textContent = uniqueMaterials.size;
            document.getElementById('statsAverage').textContent = loadedFiles.length > 0 ? 
                (totalCost / loadedFiles.length).toFixed(0) : '0';
        }

        function selectFile(index) {
            currentFileIndex = index;
            updateFilesTable();
            drawCurrentFile();
            const file = loadedFiles[index];
            document.getElementById('canvasInfo').textContent = file.name;
            document.getElementById('dimensionsInfo').textContent = 
                `Dimensiones: ${file.bounds.width.toFixed(1)}mm x ${file.bounds.height.toFixed(1)}mm`;
        }

        function removeFile(index) {
            loadedFiles.splice(index, 1);
            
            if (currentFileIndex === index) {
                currentFileIndex = -1;
                clearCanvas();
                document.getElementById('canvasInfo').textContent = 'Seleccione un archivo de la tabla para visualizarlo';
                document.getElementById('dimensionsInfo').textContent = 'Dimensiones: No seleccionado';
            } else if (currentFileIndex > index) {
                currentFileIndex--;
            }
            
            updateFilesTable();
            updateResults();
            
            if (loadedFiles.length > 0 && currentFileIndex === -1) {
                selectFile(0);
            }
        }

        function filterFiles() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const materialFilter = document.getElementById('materialFilter').value;
            const costFilter = document.getElementById('costFilter').value;
            
            const rows = document.querySelectorAll('#filesTableBody tr');
            
            rows.forEach(row => {
                const fileName = row.cells[0].textContent.toLowerCase();
                const fileMaterial = row.cells[1].querySelector('select').value;
                const fileCost = parseFloat(row.cells[6].textContent.replace('$', ''));
                
                let show = true;
                
                // Filtro de búsqueda
                if (searchTerm && !fileName.includes(searchTerm)) {
                    show = false;
                }
                
                // Filtro de material
                if (materialFilter && fileMaterial !== materialFilter) {
                    show = false;
                }
                
                // Filtro de costo
                if (costFilter === 'high' && fileCost < 30000) {
                    show = false;
                } else if (costFilter === 'low' && fileCost >= 10000) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }

        function exportToCSV() {
            if (loadedFiles.length === 0) {
                alert('No hay datos para exportar');
                return;
            }
            
            let csv = 'Archivo,Material,Dimensiones,Longitud (m),Contornos,Tiempo (min),Costo Unitario,Cantidad,Costo Total\n';
            
            loadedFiles.forEach(file => {
                const unitCost = file.cost / file.quantity;
                csv += `"${file.name}","${file.material}","${file.bounds.width.toFixed(0)}x${file.bounds.height.toFixed(0)}mm",${(file.info.totalLengthMm / 1000).toFixed(2)},${file.info.totalEntities},${file.time.toFixed(1)},$${unitCost.toFixed(0)},${file.quantity},$${file.cost.toFixed(0)}\n`;
            });
            
            // Agregar totales
            csv += `\nTOTALES,,,${(loadedFiles.reduce((sum, f) => sum + f.info.totalLengthMm, 0) / 1000).toFixed(2)},${loadedFiles.reduce((sum, f) => sum + f.info.totalEntities, 0)},${loadedFiles.reduce((sum, f) => sum + f.time, 0).toFixed(1)},,${loadedFiles.reduce((sum, f) => sum + f.quantity, 0)},$${loadedFiles.reduce((sum, f) => sum + f.cost, 0).toFixed(0)}`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cotizacion_corte_laser.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function saveProject() {
            const project = {
                files: loadedFiles,
                settings: {
                    costPerMinute: COST_PER_MINUTE,
                    timePerContour: TIME_PER_CONTOUR_S
                }
            };
            
            const dataStr = JSON.stringify(project);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'proyecto_corte_laser.json';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function showFileConfig(index) {
            alert(`Configuración para: ${loadedFiles[index].name}\n\nEsta funcionalidad permite ajustes específicos por archivo.`);
        }

        function saveConfig() {
            COST_PER_MINUTE = parseFloat(document.getElementById('globalCostPerMinute').value) || 10000;
            TIME_PER_CONTOUR_S = parseFloat(document.getElementById('globalTimePerContour').value) || 3.5;
            
            // Recalcular todos los costos
            loadedFiles.forEach((file, index) => {
                updateFileCost(index);
            });
            
            updateResults();
            document.getElementById('configModal').style.display = 'none';
        }

        // Funciones de dibujo y manipulación del canvas
        function drawCurrentFile() {
            if (currentFileIndex === -1 || !loadedFiles[currentFileIndex]) {
                clearCanvas();
                return;
            }
            
            const file = loadedFiles[currentFileIndex];
            drawDxf(file.dxf, file.bounds);
        }

        function clearCanvas() {
            const canvas = document.getElementById('dxfCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function distance(p1, p2) {
            return Math.sqrt(Math.pow(p2[0] - p1[0], 2) + Math.pow(p2[1] - p1[1], 2));
        }

        function getDxfBounds(dxf) {
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            dxf.entities.forEach(entity => {
                const vertices = [];
                
                if (entity.type === 'LINE') {
                    if (entity.start) vertices.push(entity.start);
                    if (entity.end) vertices.push(entity.end);
                } else if (entity.vertices) {
                    vertices.push(...entity.vertices);
                } else if (entity.center && entity.radius) { 
                    const r = entity.radius;
                    vertices.push(
                        { x: entity.center.x - r, y: entity.center.y },
                        { x: entity.center.x + r, y: entity.center.y },
                        { x: entity.center.x, y: entity.center.y - r },
                        { x: entity.center.x, y: entity.center.y + r }
                    );
                } else if (entity.controlPoints) { 
                    vertices.push(...entity.controlPoints);
                }
                
                vertices.forEach(v => {
                    if (v && typeof v.x === 'number' && typeof v.y === 'number') {
                        minX = Math.min(minX, v.x);
                        minY = Math.min(minY, v.y);
                        maxX = Math.max(maxX, v.x);
                        maxY = Math.max(maxY, v.y);
                    }
                });
            });

            if (minX === Infinity) {
                minX = minY = -100;
                maxX = maxY = 100;
            }

            const width = maxX - minX;
            const height = maxY - minY;

            return { minX, minY, maxX, maxY, width, height };
        }

        function drawDxf(dxf, bounds) {
            const canvas = document.getElementById('dxfCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar grid si está activado
            if (showGrid) {
                drawGrid(ctx, canvas.width, canvas.height);
            }
            
            const dx = bounds.maxX - bounds.minX;
            const dy = bounds.maxY - bounds.minY;
            
            if (dx === 0 && dy === 0) return;

            const padding = 0.9;
            const scaleX = canvas.width / dx;
            const scaleY = canvas.height / dy;
            let scale = Math.min(scaleX, scaleY) * padding * currentScale;
            
            const offsetX = canvas.width / 2 - (bounds.minX + dx / 2) * scale + currentOffsetX;
            const offsetY = canvas.height / 2 + (bounds.minY + dy / 2) * scale + currentOffsetY;

            ctx.save();
            ctx.translate(offsetX, offsetY);
            ctx.scale(scale, -scale);

            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 2 / scale;

            dxf.entities.forEach(entity => {
                ctx.beginPath();
                switch (entity.type) {
                    case 'LINE':
                        if (entity.start && entity.end) {
                            ctx.moveTo(entity.start.x, entity.start.y);
                            ctx.lineTo(entity.end.x, entity.end.y);
                        }
                        break;
                    case 'LWPOLYLINE':
                    case 'POLYLINE':
                        if (entity.vertices && entity.vertices.length > 0) {
                            ctx.moveTo(entity.vertices[0].x, entity.vertices[0].y);
                            for (let i = 1; i < entity.vertices.length; i++) {
                                ctx.lineTo(entity.vertices[i].x, entity.vertices[i].y);
                            }
                            if (entity.isClosed) ctx.closePath();
                        }
                        break;
                    case 'ARC':
                        if (entity.center && entity.radius && entity.startAngle !== undefined && entity.endAngle !== undefined) {
                            ctx.arc(entity.center.x, entity.center.y, entity.radius, 
                                    entity.startAngle * Math.PI / 180, entity.endAngle * Math.PI / 180, 
                                    entity.startAngle > entity.endAngle);
                        }
                        break;
                    case 'CIRCLE':
                        if (entity.center && entity.radius) {
                            ctx.arc(entity.center.x, entity.center.y, entity.radius, 0, 2 * Math.PI);
                        }
                        break;
                    case 'ELLIPSE':
                        if (entity.center && typeof entity.majorAxis === 'number' && typeof entity.axisRatio === 'number') {
                            ctx.ellipse(entity.center.x, entity.center.y, entity.majorAxis, 
                                        entity.majorAxis * entity.axisRatio, 0, 0, 2 * Math.PI);
                        }
                        break;
                    case 'SPLINE':
                        if (entity.controlPoints && entity.controlPoints.length > 0) {
                            ctx.moveTo(entity.controlPoints[0].x, entity.controlPoints[0].y);
                            for (let i = 1; i < entity.controlPoints.length; i++) {
                                ctx.lineTo(entity.controlPoints[i].x, entity.controlPoints[i].y);
                            }
                        }
                        break;
                }
                ctx.stroke();
            });
            
            ctx.restore();
        }

        function drawGrid(ctx, width, height) {
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            const gridSize = 50;
            
            // Líneas verticales
            for (let x = 0; x <= width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            // Líneas horizontales
            for (let y = 0; y <= height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
        }

        // Funciones de arrastre del canvas
        function startDragging(e) {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - lastMouseX;
            const deltaY = e.clientY - lastMouseY;
            
            currentOffsetX += deltaX;
            currentOffsetY += deltaY;
            
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            
            drawCurrentFile();
            e.preventDefault();
        }

        function stopDragging() {
            isDragging = false;
        }
    </script>
</body>
</html>
