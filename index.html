<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora de Materiales</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 1700px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .config-section {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 6px;
      flex-wrap: wrap;
    }
    .config-item {
      display: flex;
      flex-direction: column;
    }
    .config-item label {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 0.9em;
    }
    .config-item input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 120px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.75em;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #3498db;
      color: white;
      font-weight: bold;
      white-space: nowrap;
    }
    input[type=number], select {
      width: 100%;
      padding: 4px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .total {
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 20px;
      text-align: right;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 4px;
    }
    button {
      margin-top: 10px;
      padding: 8px 15px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    .formato {
      background-color: #d4ffd4;
    }
    .retal {
      background-color: #fff8cd;
    }
    .delete-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .delete-btn:hover {
      background-color: #c0392b;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .result-cell {
      font-weight: bold;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .pliegue-input {
      width: 80px;
      font-size: 0.7em;
    }
    .cantidad-pliegues-input {
      width: 60px;
      font-size: 0.8em;
    }
    .precio-kg-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .precio-kg-manual {
      width: 80px;
      font-size: 0.7em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Calculadora de Materiales</h2>

    <div class="config-section">
      <div class="config-item">
        <label for="descuentoAumento">Descuento/Aumento (%):</label>
        <input type="number" id="descuentoAumento" step="0.01" value="0">
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="aplicarDescuento">
        <label for="aplicarDescuento">Aplicar descuento</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="aplicarAumento" checked>
        <label for="aplicarAumento">Aplicar aumento</label>
      </div>
    </div>

    <div id="loading" class="loading">Cargando datos de materiales...</div>

    <table id="tabla" style="display: none;">
      <thead>
        <tr>
          <th>Material</th>
          <th>Ancho (mm)</th>
          <th>Largo (mm)</th>
          <th>Espesor (mm)</th>
          <th>Cantidad</th>
          <th>Peso Unit. (kg)</th>
          <th>Peso Total (kg)</th>
          <th>Tipo</th>
          <th>Precio kg venta</th>
          <th>Precio unitario</th>
          <th>Cant. Pliegues</th>
          <th>Precio pliegue</th>
          <th>Precio unitario + pliegue</th>
          <th>Precio total</th>
          <th>+IVA (19%)</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="actions">
      <button onclick="agregarFila()" id="btnAgregar" style="display: none;">Agregar Fila</button>
      <div class="total" id="totalFinal">Total + IVA (19%): $0.00</div>
    </div>
  </div>

  <script>
    let db = [];

    // Cargar datos del JSON
    fetch('materiales.json')
      .then(res => {
        if (!res.ok) {
          throw new Error('Error al cargar el archivo materiales.json');
        }
        return res.json();
      })
      .then(data => {
        db = data;
        console.log('Materiales cargados:', db.length, 'registros');
        
        // Ocultar loading y mostrar tabla
        document.getElementById('loading').style.display = 'none';
        document.getElementById('tabla').style.display = 'table';
        document.getElementById('btnAgregar').style.display = 'block';
        
        // Agregar primera fila
        agregarFila();
        
        // Configurar eventos después de cargar los datos
        configurarEventos();
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('loading').innerHTML = 'Error al cargar los datos: ' + error.message;
      });

    // --- FUNCIONES DE CÁLCULO DE MATERIAL Y PLIEGUE ---
    function calcularPrecioPliegue(peso) {
      const y0 = 4500;
      const y1 = 160000;
      const x0 = 4;
      const x1 = 720;
      return peso <= x0 ? y0 : peso >= x1 ? y1 : y0 + ((peso - x0) / (x1 - x0)) * (y1 - y0);
    }

    function detectarFormato(material, ancho, largo, espesor) {
      if (!material || !ancho || !largo || !espesor) return null;
      
      // Buscar coincidencia exacta de formato
      const formatoExacto = db.find(item =>
        item.MATERIAL === material &&
        Math.abs(parseFloat(item["Ancho (mm)"]) - ancho) < 1 &&
        Math.abs(parseFloat(item["Largo (mm)"]) - largo) < 1 &&
        Math.abs(parseFloat(item["Calibre (mm)"]) - espesor) < 0.01
      );
      
      return formatoExacto;
    }

    function obtenerEspesoresPorMaterial(material) {
      if (!material) return [];
      return [...new Set(db
        .filter(item => item.MATERIAL === material)
        .map(item => parseFloat(item["Calibre (mm)"]))
      )].sort((a, b) => a - b);
    }

    function calcularPeso(ancho, largo, espesor, densidad) {
      if (!ancho || !largo || !espesor || !densidad) return 0;
      
      // Convertir densidad de string a número
      const densidadNum = parseFloat(densidad);
      return (ancho * largo * espesor * densidadNum);
    }

    function limpiarValorMonetario(valor) {
      if (!valor) return 0;
      return parseFloat(valor.toString().replace(/[^\d.]/g, '')) || 0;
    }

    function actualizarEspesores(fila, material) {
      const espesorSelect = fila.querySelector(".espesor");
      const espesores = obtenerEspesoresPorMaterial(material);
      
      // Guardar el valor actual
      const valorActual = espesorSelect.value;
      
      // Actualizar opciones
      espesorSelect.innerHTML = '<option value="">Seleccionar</option>' +
        espesores.map(e => `<option value="${e}">${e}</option>`).join('');
      
      // Restaurar valor si todavía existe
      if (valorActual && espesores.includes(parseFloat(valorActual))) {
        espesorSelect.value = valorActual;
      }
    }

	function actualizarFila(fila) {
	  // ... código anterior hasta el cálculo de precioTotal ...

	  // Calcular precios totales
	  const pesoTotal = pesoUnitario * cantidad;
	  const precioTotal = precioUnitarioConPliegue * cantidad;
	  
	  // NUEVA LÓGICA: Calcular el precio con IVA redondeado a miles, luego quitar el IVA
	  const precioIVARedondeado = Math.round((precioTotal * 1.19) / 1000) * 1000;
	  const precioTotalRedondeado = Math.round(precioIVARedondeado / 1.19 / 1000) * 1000;
	  const precioUnitarioConPliegueRedondeado = precioTotalRedondeado / cantidad;
	  const precioUnitarioBaseRedondeado = Math.round((precioUnitarioConPliegueRedondeado - precioPliegueTotal) / 1000) * 1000;

	  // Actualizar todas las celdas con valores redondeados
	  fila.querySelector(".pesoUnit").innerText = pesoUnitario.toFixed(2);
	  fila.querySelector(".pesoTotal").innerText = pesoTotal.toFixed(2);
	  fila.querySelector(".precioKgCalculado").innerText = precioKg.toFixed(2);
	  
	  // Usar los valores redondeados
	  fila.querySelector(".precioUnit").innerText = precioUnitarioBaseRedondeado;
	  fila.querySelector(".precioUnitConPliegue").innerText = precioUnitarioConPliegueRedondeado;
	  fila.querySelector(".precioTotal").innerText = precioTotalRedondeado;
	  fila.querySelector(".precioIVA").innerText = precioIVARedondeado;

	  actualizarTotal();
	}

		function actualizarTotal() {
		  let total = 0;
		  document.querySelectorAll(".precioIVA").forEach(td => {
			total += parseFloat(td.innerText.replace(/,/g, '')) || 0;
		  });
		  document.getElementById("totalFinal").innerText = `Total + IVA (19%): $${total.toLocaleString()}`;
		}

    function agregarFila() {
      const tbody = document.querySelector("#tabla tbody");
      const fila = document.createElement("tr");

      // Obtener materiales únicos del JSON cargado
      const materiales = [...new Set(db.map(i => i.MATERIAL))];

      fila.innerHTML = `
        <td>
          <select class="material">
            <option value="">Seleccionar</option>
            ${materiales.map(m => `<option value="${m}">${m}</option>`).join('')}
          </select>
        </td>
        <td><input type="number" class="ancho" step="1" min="0" placeholder="mm"></td>
        <td><input type="number" class="largo" step="1" min="0" placeholder="mm"></td>
        <td>
          <select class="espesor">
            <option value="">Seleccionar material primero</option>
          </select>
        </td>
        <td><input type="number" class="cantidad" value="1" min="1"></td>
        <td class="pesoUnit result-cell">0.00</td>
        <td class="pesoTotal result-cell">0.00</td>
        <td class="tipo">-</td>
        <td>
          <div class="precio-kg-container">
            <span class="precioKgCalculado result-cell" style="font-size: 0.7em;">0.00</span>
            <input type="number" class="precioKgManual" step="0.01" min="0" placeholder="Manual" style="width: 80px; font-size: 0.7em;">
          </div>
        </td>
        <td class="precioUnit result-cell">0.00</td>
        <td><input type="number" class="cantidadPliegues" value="0" min="0" step="1" style="width: 60px; font-size: 0.8em;"></td>
        <td>
          <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
            <span class="precioPliegueCalculado result-cell" style="font-size: 0.7em;">0.00</span>
            <input type="number" class="precioPliegueManual" step="1" min="0" placeholder="Manual" style="width: 80px; font-size: 0.7em;">
          </div>
        </td>
        <td class="precioUnitConPliegue result-cell">0.00</td>
        <td class="precioTotal result-cell">0.00</td>
        <td class="precioIVA result-cell">0.00</td>
        <td><button class="delete-btn" onclick="this.parentElement.parentElement.remove(); actualizarTotal();">Eliminar</button></td>
      `;

      // Evento para actualizar espesores cuando cambia el material
      fila.querySelector(".material").addEventListener("change", function() {
        actualizarEspesores(fila, this.value);
        actualizarFila(fila);
      });

      // Eventos para todos los inputs y selects
      const inputs = fila.querySelectorAll("input, select");
      inputs.forEach(input => {
        input.addEventListener("input", () => {
          console.log('Input cambiado:', input.className, input.value);
          actualizarFila(fila);
        });
      });

      tbody.appendChild(fila);
      
      // Actualizar la fila recién creada
      actualizarFila(fila);
    }

    function configurarEventos() {
      document.getElementById("aplicarDescuento").addEventListener("change", () => {
        document.querySelectorAll("#tabla tbody tr").forEach(fila => {
          actualizarFila(fila);
        });
      });
      
      document.getElementById("aplicarAumento").addEventListener("change", () => {
        document.querySelectorAll("#tabla tbody tr").forEach(fila => {
          actualizarFila(fila);
        });
      });
      
      document.getElementById("descuentoAumento").addEventListener("input", () => {
        document.querySelectorAll("#tabla tbody tr").forEach(fila => {
          actualizarFila(fila);
        });
      });
    }
  </script>
</body>
</html>
