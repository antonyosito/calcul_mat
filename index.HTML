<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora de Materiales</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    input[type=number], select { width: 100%; }
    .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
    button { margin-top: 10px; }
    .formato { background-color: #d4ffd4; }
    .retal { background-color: #fff8cd; }
  </style>
</head>
<body>

  <h2>Calculadora de Materiales</h2>

  <label>Precio kg compra (manual): <input type="number" id="precioCompra" step="0.01" value="4850"></label>
  <label>Margen (%): <input type="number" id="margen" step="0.01" value="30"></label>

  <table id="tabla">
    <thead>
      <tr>
        <th>Material</th>
        <th>Ancho (mm)</th>
        <th>Largo (mm)</th>
        <th>Espesor (mm)</th>
        <th>Cantidad</th>
        <th>Peso (kg)</th>
        <th>Tipo</th>
        <th>Precio kg venta</th>
        <th>Precio total</th>
        <th>+IVA (19%)</th>
        <th>❌</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="agregarFila()">Agregar Fila</button>
  <div class="total" id="totalFinal">Total + IVA: $0.00</div>

  <script>
    let db = [];

    fetch('materiales.json')
      .then(res => res.json())
      .then(data => {
        db = data;
        agregarFila();
      });

    function detectarFormato(material, ancho, largo, espesor) {
      return db.find(item =>
        item.material === material &&
        Math.abs(item.ancho_mm - ancho) < 5 &&
        Math.abs(item.largo_mm - largo) < 5 &&
        Math.abs(item.espesor_mm - espesor) < 0.1
      );
    }

    function calcularPeso(ancho, largo, espesor, densidad) {
      return (ancho * largo * espesor * densidad) / 1e6;
    }

    function actualizarFila(fila) {
      const material = fila.querySelector(".material").value;
      const ancho = parseFloat(fila.querySelector(".ancho").value) || 0;
      const largo = parseFloat(fila.querySelector(".largo").value) || 0;
      const espesor = parseFloat(fila.querySelector(".espesor").value) || 0;
      const cantidad = parseFloat(fila.querySelector(".cantidad").value) || 1;

      const item = detectarFormato(material, ancho, largo, espesor);

      if (!item) {
        fila.className = "retal";
        fila.querySelector(".tipo").innerText = "Retal";
        fila.querySelector(".precioKg").innerText = "0.00";
        fila.querySelector(".precioTotal").innerText = "0.00";
        fila.querySelector(".precioIVA").innerText = "0.00";
        actualizarTotal();
        return;
      }

      fila.className = "formato";
      fila.querySelector(".tipo").innerText = "Formato";

      const peso = calcularPeso(ancho, largo, espesor, item.densidad);
      const precioKg = item.precio_kg_venta_cortado;
      const precioTotal = peso * precioKg * cantidad;
      const precioIVA = precioTotal * 1.19;

      fila.querySelector(".peso").innerText = peso.toFixed(2);
      fila.querySelector(".precioKg").innerText = precioKg.toFixed(2);
      fila.querySelector(".precioTotal").innerText = precioTotal.toFixed(2);
      fila.querySelector(".precioIVA").innerText = precioIVA.toFixed(2);

      actualizarTotal();
    }

    function actualizarTotal() {
      let total = 0;
      document.querySelectorAll(".precioIVA").forEach(td => {
        total += parseFloat(td.innerText) || 0;
      });
      document.getElementById("totalFinal").innerText = `Total + IVA (19%): $${total.toFixed(2)}`;
    }

    function agregarFila() {
      const tbody = document.querySelector("#tabla tbody");
      const fila = document.createElement("tr");

      const materiales = [...new Set(db.map(i => i.material))];

      fila.innerHTML = `
        <td><select class="material">${materiales.map(m => `<option value="${m}">${m}</option>`).join('')}</select></td>
        <td><input type="number" class="ancho" step="1"></td>
        <td><input type="number" class="largo" step="1"></td>
        <td><input type="number" class="espesor" step="0.1"></td>
        <td><input type="number" class="cantidad" value="1"></td>
        <td class="peso">0.00</td>
        <td class="tipo">-</td>
        <td class="precioKg">0.00</td>
        <td class="precioTotal">0.00</td>
        <td class="precioIVA">0.00</td>
        <td><button onclick="this.parentElement.parentElement.remove();actualizarTotal();">❌</button></td>
      `;

      fila.querySelectorAll("input, select").forEach(input => {
        input.addEventListener("input", () => actualizarFila(fila));
      });

      tbody.appendChild(fila);
    }
  </script>

</body>
</html>